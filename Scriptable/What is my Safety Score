// Variables used by Scriptable.
// These must be at the very top of the file. Do not edit.
// icon-color: deep-blue; icon-glyph: magic;
// Created by Sunil Joseph
// @unplgd3
// github.com/sunil-joseph/tesla-siri-shortcuts

const vin = '5YJ3E1EBXJF083972';

// extending Number to handle rounding to a certain decimal place
Number.prototype.round = function(places) {
  return +(Math.round(this + "e+" + places)  + "e-" + places);
}

// Calculate the miles needed to get to a target score
const milesNeeded = (score, aggregateScore, totalMiles) => {
  // Though Tesla displays a whole number, it's actually a rounded figure  
  // So if you need a score of 99, you need to aim for 98.5
  const target = score - 0.5;
  return ((target * totalMiles - aggregateScore) / (100 - target)).round(1)
}

const fm = FileManager.iCloud();
const jsonString = fm.readString(fm.libraryDirectory() + '/tokens.json');
const {access_token: accessToken} = JSON.parse(jsonString);

// Endpoint requires a timezone, the Tesla app localizes the response based on your timezone
// We'll use your current timezone
const timezone = encodeURIComponent(Intl.DateTimeFormat().resolvedOptions().timeZone);

const url = `https://akamai-apigateway-vfx.tesla.com/safety-rating/daily-metrics?vin=${vin}&timezone=${timezone}&deviceLanguage=en&deviceCountry=US&appVersion=4.1.0-663&hasInsurance=false`;

// Make the call to Tesla
const req = new Request(url);
req.headers = {
  'Authorization': `Bearer ${accessToken}`
};
const resp = await req.loadJSON();

// Grab the daily metrics
const dailyAggregation = resp.dailyAggregation.metrics;

let weightedScore = 0;
let totalMiles = 0;

// Loop through all the miles and scores
for (const day of dailyAggregation) {
  const {safetyScore, milesDriven} = day;
  
  // Weighted score is the score * miles
  weightedScore += safetyScore * milesDriven;
  totalMiles += milesDriven;
}

// Calculate the aggregate score
const safetyScore = (weightedScore/totalMiles).toFixed(2);

let message = `Your safety score is ${safetyScore}.`

if (safetyScore >= 99.5) {
  // Rockstar status, score of 99.5 is treated as 100
  message += ` Look at you!! You are at 100!!`;
}
else if (safetyScore >= 98.5) {
  // Right now, score of 99 is needed to get beta
  message += ` You sir, are on track to get beta! Keep it up!!`;
  milesTo100 = milesNeeded(100, weightedScore, totalMiles);
  message += ` If you drive with a perfect score for ${milesTo100} miles, you'll have a score of 100!`;
}
else {
  // Anything else, well show the score needed to get to the next digit
  milesTo100 = milesNeeded(100, weightedScore, totalMiles);
  targetScore = Math.round(safetyScore) + 1;
  milesToTarget = milesNeeded(targetScore, weightedScore, totalMiles);
 
  message += ` If you drive with a perfect score for ${milesTo100} miles, you'll have a score of 100!`;
  message += ` If you drive with a perfect score for ${milesToTarget} miles, you'll have a score of ${targetScore}!`;
  
}

console.log(message);

return {
  message
}

Script.complete()
